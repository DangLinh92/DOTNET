 SELECT 
  A.CASSETTE_ID 'Cassette ID', 
  A.LOT_ID 'Lot ID', 
  A.LOT_DESCRIPTION 'Description', 
  A.SERIES 'Series', 
  A.MATERIAL_ID 'Material', 
  A.LOT_TYPE 'Lot Type', 
  A.LOT_CATEGORY 'Lot Category', 
  A.OPERATION_ID 'Operation ID', 
  A.OPERATION_SHORT_NAME 'Operation Name', 
  A.LOT_STATUS 'Status', 
  A.MOVEIN_DTTM 'Operation Input Time', 
  A.STAY_DAY 'Stay Day', 
  A.CHIP_QTY 'Chip Qty', 
  A.PO_ID 'ERP Product Order', 
  A.WAFER_MATERIAL 'Wafer Material', 
  A.WAFER_VENDOR 'Wafer Vendor', 
  A.FAB_CASSETTE_ID 'FAB Cassette ID', 
  A.FAB_LOT_ID 'FAB Lot ID' 
FROM 
  (
    SELECT 
      L.CASSETTE_ID, 
      L.LOT_ID, 
      L.LOT_DESCRIPTION, 
      M.MATERIAL_GROUP1 AS SERIES, 
      L.MATERIAL_ID, 
      T.VALUE1 AS LOT_TYPE, 
      C.VALUE1 AS LOT_CATEGORY, 
      L.OPERATION_ID, 
      O.OPERATION_SHORT_NAME, 
      L.LOT_STATUS, 
      L.MOVEIN_DTTM, 
      ROUND(
       (SELECT CONVERT(FLOAT(2),DATEDIFF(MI, S.PREV_DATE, S.NEXT_DATE),2) / CONVERT(FLOAT(2),60) AS TIME_SE
			  FROM (SELECT CONVERT(DATETIME, 
								   SUBSTRING(L.MOVEIN_DTTM, 1,4) + '-' + SUBSTRING(L.MOVEIN_DTTM, 5,2) + '-' + 
								   SUBSTRING(L.MOVEIN_DTTM, 7,2) + ' ' + SUBSTRING(L.MOVEIN_DTTM, 9,2) + ':' + 
								   SUBSTRING(L.MOVEIN_DTTM,11,2) + ':' + SUBSTRING(L.MOVEIN_DTTM,13,2)
								   ) PREV_DATE,
						           (GETDATE()
								   ) NEXT_DATE
					) AS S) / 24, 								  
        1
      ) AS STAY_DAY, 
      L.QTY1 AS CHIP_QTY, 
      L.PO_ID, 
      L.LOT_UDF3 AS WAFER_VENDOR, 
      L.LOT_UDF4 AS WAFER_MATERIAL, 
      L.LOT_UDF10 AS FAB_CASSETTE_ID, 
      L.ORIGINAL_LOT_ID AS FAB_LOT_ID, 
      L.HOLD_FLAG AS HOLD_FLAG, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN L.HOLD_DTTM ELSE '' END AS HOLD_DTTM, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN L.HOLD_CODE ELSE '' END AS HOLD_CODE, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN L.HOLD_NAME ELSE '' END AS HOLD_NAME, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN L.HOLD_USER_ID ELSE '' END AS HOLD_USER_ID, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN U.USER_NAME ELSE '' END AS HOLD_USER_NAME, 
      CASE WHEN L.HOLD_FLAG = 'Y' THEN L.HOLD_COMMENT ELSE '' END AS HOLD_COMMENT 
    FROM 
      NM_LOTS L (NOLOCK) 
      INNER JOIN NM_OPERATIONS O (NOLOCK) ON O.SITE_ID = L.SITE_ID 
      AND O.OPERATION_ID = L.OPERATION_ID 
      INNER JOIN NM_MATERIALS M (NOLOCK) ON M.SITE_ID = L.SITE_ID 
      AND M.MATERIAL_ID = L.MATERIAL_ID 
      LEFT OUTER JOIN NB_USERS U (NOLOCK) ON U.USER_ID = L.HOLD_USER_ID 
      LEFT OUTER JOIN NB_CODE_DATA T (NOLOCK) ON T.SITE_ID = L.SITE_ID 
      AND T.PK1 = L.LOT_TYPE 
      AND T.TABLE_ID = 'LOT_TYPE' 
      LEFT OUTER JOIN NB_CODE_DATA C (NOLOCK) ON C.SITE_ID = L.SITE_ID 
      AND C.PK1 = L.LOT_CATEGORY 
      AND C.TABLE_ID = 'LOT_CATEGORY' 
    WHERE 
      L.SITE_ID = 'WHWLP' 
      AND L.DELETE_FLAG <> 'Y' 
      AND L.OPERATION_ID IN (
'OP06000', 'OP06500', 'OP07000', 
        'OP06700', 'OP08000', 'OP10000', 
        'OP09000', 'OP11000'
      ) 
      AND L.LOT_TYPE IN ('A', 'B') 
      AND M.MATERIAL_TYPE IN ('HALB') 
      AND L.HOLD_FLAG <> 'Y'
  ) A 
WHERE 
  1 = 1 
  AND A.STAY_DAY >= 0 
ORDER BY 
  A.MOVEIN_DTTM, 
  A.OPERATION_ID, 
  A.LOT_ID